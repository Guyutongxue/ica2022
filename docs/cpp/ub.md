# 未定义行为

## 什么是未定义行为

C++ 标准规定，一段源代码在编译后有六种可能的结果：
- **良构**（Well-form）。此时，程序运行时的所有行为都被标准所规定。
- **谬构**（Ill-form，又译“病式”），俗称“编译失败”。
- **IFNDR**（Ill-formed, no diagnostic required），可以理解为介于编译成功和编译失败之间的状态。
- 存在**实现定义行为**（Implementation-defined behavior）。程序运行时的所有行为，都被 C++ 标准、编译器文档和操作系统文档规定。这是最常见的一种结果。
- 存在**未指明行为**（Unspecified behavior）。程序运行时的行为，可能是若干种被规定的行为中的某一种，但具体到哪种是不确定的。
- 存在**未定义行为**（Undefined behavior）。程序运行时的行为没有被任何文档限制，可能做出任意的操作。

除了“谬构”和 IFNDR 以外，其余四种都可以算作“编译成功”。但编译成功不代表程序总是在做正确的事情；如果代码里存在一些代码，使得程序编译出了“未定义行为”，那么程序运行的时候，可能出现各种结果——
- 当做无事发生；
- 运行时错误；
- 运行成功，但出现了一些不应发生的错误；
- 程序为你启动了一些电脑游戏；
- 程序帮你把计算机关掉了。
- ……

> 后两种不是开玩笑，在早期版本的 GCC 中确实存在这种编译策略。

而某次运行到底会发生什么，是谁也不知道的。所以，存在“未定义行为”的代码是很危险的，它也可能是导致你提交到“编程网格”的代码出现错误的原因。

## 常见未定义行为列表

### 算术类型除以零

```cpp
int main() {
    int a{42 / 0}; // 未定义行为，一般引发程序运行时错误
    double b{42.0 / 0.0}; // 未定义行为，但一般不会引发运行时错误
}
```

### 使用不确定的值

```cpp
#include <iostream>

int main() {
    int a; // a 的值不确定
    int b{a}; // 未定义行为：使用不确定的值

    char str[100]; // str 的值不确定
    std::cout << str; // 未定义行为：输出不确定的值

    int b{}; // OK，初始化为 0
    char str2[100]{}; // OK，全部初始化为 '\0'
}
```

### 非法指针访问

```cpp
#include <iostream>

int main() {
    int* p;
    *p = 42; // 未定义行为：访问不确定的指针值

    int a[5]{};
    std::cout << a[5]; // 未定义行为：数组越界
    std::cout << a[-1]; // 未定义行为：数组越界

    int* q{nullptr};
    *q = 42; // 未定义行为：对空指针解地址
}

```

### 抵达函数体结尾但未 return

```cpp
#include <iostream>

int f() {
    std::cout << "f()" << std::endl;
} // 未定义行为：返回 int 但未 return

void g() {
    std::cout << "g()" << std::endl;
} // OK，相当于结尾 return;

int main() {
  f(); // 触发未定义行为
  g();
} // OK，main 函数可省略 return 0;
```

### 有符号整数溢出

```cpp
#include <limits>

int main() {
    // 当 a 为 int 类型最大值时
    int a = std::numeric_limits<int>::max();
    a++; // 未定义行为

    unsigned b = std::numeric_limits<unsigned>::max();
    b++; // OK，回绕到 0
}
```

-----

此外，部分二元运算符的求值顺序是“未指明行为”，比如： `f() + g()` 时先调用 `f` 还是先调用 `g` 是未知的。虽然它没有未定义行为那么可怕，但还是要避免。

